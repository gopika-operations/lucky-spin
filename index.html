<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>V√≤ng quay may m·∫Øn</title>
  <style>
    body{font-family:Arial;max-width:520px;margin:24px auto;padding:0 14px}
    .card{border:1px solid #ddd;border-radius:12px;padding:14px;margin:10px 0}
    input{width:100%;padding:10px;border:1px solid #ccc;border-radius:10px;margin:6px 0}
    button{padding:10px 14px;border:none;border-radius:10px;background:#111;color:#fff;font-weight:700;cursor:pointer}
    button:disabled{background:#888;cursor:not-allowed}
    pre{background:#f6f6f6;padding:10px;border-radius:10px;white-space:pre-wrap}
  </style>
</head>
<body>
  <div class="card">
    <h2 style="margin:0 0 6px">V√≤ng quay may m·∫Øn</h2>
    <div style="color:#666">Nh·∫≠p <b>driver_id</b> v√† <b>token</b> ƒë·ªÉ ki·ªÉm tra l∆∞·ª£t v√† quay.</div>
  </div>

  <div class="card">
    <input id="driver" placeholder="driver_id (vd: 84335405559)">
    <input id="token" placeholder="token (vd: 2003)">
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button id="btnCheck">Ki·ªÉm tra l∆∞·ª£t</button>
      <button id="btnSpin" disabled>Quay</button>
    </div>
  </div>

  <div class="card">
    <div id="msg" style="font-weight:700;margin-bottom:8px"></div>
    <pre id="out"></pre>
  </div>

<script>
  const API = "https://script.google.com/macros/s/AKfycbxtvfFvlp-tszkCG7DQUpmOHXAfmeK3JaUddh7dbsoKFZImelCB4XCT39k46Lskophu/exec";

  function jsonp(url) {
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Math.random().toString(36).slice(2);
      window[cb] = (data) => { cleanup(); resolve(data); };
      const s = document.createElement("script");
      const cleanup = () => { try{delete window[cb]}catch(e){} s.remove(); };
      s.onerror = () => { cleanup(); reject(new Error("JSONP error")); };
      s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
      document.body.appendChild(s);
    });
  }

  async function api(action, driver_id, token) {
    const url = `${API}?action=${action}&driver_id=${encodeURIComponent(driver_id)}&token=${encodeURIComponent(token)}`;
    return await jsonp(url);
  }

  const driverEl = document.getElementById("driver");
  const tokenEl  = document.getElementById("token");
  const out = document.getElementById("out");
  const msg = document.getElementById("msg");
  const btnSpin = document.getElementById("btnSpin");

  function setText(m, o){ msg.textContent = m || ""; out.textContent = o || ""; }

  document.getElementById("btnCheck").onclick = async () => {
    setText("ƒêang ki·ªÉm tra...", "");
    try {
      const res = await api("check", driverEl.value.trim(), tokenEl.value.trim());
      if (!res.ok) return setText("‚ùå " + res.error, JSON.stringify(res, null, 2));
      setText(`‚úÖ C√≤n ${res.driver.spins_remaining} l∆∞·ª£t (ƒë∆∞·ª£c ${res.driver.spins_earned} / ƒë√£ d√πng ${res.driver.spins_used})`,
              JSON.stringify(res, null, 2));
      btnSpin.disabled = !(res.driver.spins_remaining > 0);
    } catch (e) {
      setText("‚ùå L·ªói g·ªçi API", String(e));
    }
  };

  document.getElementById("btnSpin").onclick = async () => {
    setText("ƒêang quay...", "");
    btnSpin.disabled = true;
    try {
      const res = await api("spin", driverEl.value.trim(), tokenEl.value.trim());
      if (!res.ok) {
        setText("‚ùå " + res.error, JSON.stringify(res, null, 2));
        btnSpin.disabled = false;
        return;
      }
      setText(`üéâ B·∫°n tr√∫ng: ${res.prize.prize_name}`, JSON.stringify(res, null, 2));
      btnSpin.disabled = !(res.driver.spins_remaining_after > 0);
    } catch (e) {
      setText("‚ùå L·ªói g·ªçi API", String(e));
      btnSpin.disabled = false;
    }
  };
</script>
</body>
</html>
